<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>HaydiGo ‚Äî Duraklar & Rota</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css"/>

  <style>
    html, body, #map { height:100%; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }

    .panel{position:absolute; top:12px; left:12px; z-index:1000; background:#fff; border-radius:14px; width:360px; box-shadow:0 6px 18px rgba(0,0,0,.18); overflow:hidden;}
    .panel-header{background:#2f80ed; color:#fff; padding:12px 14px; font-weight:700;}
    .panel-body{padding:12px; display:flex; flex-direction:column; gap:10px;}
    .row{display:flex; flex-direction:column; gap:6px;}
    label{font-size:12px; color:#374151; font-weight:600;}
    input[type="text"]{width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; outline:none;}
    input[type="text"]:focus{border-color:#2f80ed; box-shadow:0 0 0 3px rgba(47,128,237,.1);}
    .btn{padding:10px 12px; border:0; border-radius:10px; cursor:pointer; font-weight:700;}
    .btn-primary{background:#2f80ed; color:#fff;} .btn-primary:hover{background:#2564b8;}
    .btn-ghost{background:#eef2ff; color:#1f2937;} .btn-ghost:hover{background:#e0e7ff;}
    .btn-muted{background:#f3f4f6; color:#374151;} .btn-muted:hover{background:#e5e7eb;}
    .grid-2{display:grid; grid-template-columns:1fr 1fr; gap:8px;}
    .route-info{display:none; margin-top:2px; font-size:14px; background:#f9fafb; padding:8px; border-radius:8px; border:1px solid #e5e7eb;}

    /* waypoint item + drag handle */
    .wp-item{display:grid; grid-template-columns:auto 1fr auto; gap:8px; align-items:center; padding:2px 0;}
    .drag{width:40px; height:40px; border:1px solid #e5e7eb; border-radius:10px; display:flex; align-items:center; justify-content:center; cursor:grab; user-select:none; background:#fff;}
    .drag:active{cursor:grabbing;}
    .drag::before{content:"‚ãÆ‚ãÆ"; letter-spacing:2px; color:#6b7280; font-weight:700;}
    .del{border:1px solid #e5e7eb; background:#fff; border-radius:10px; padding:0 10px; height:40px; display:flex; align-items:center; justify-content:center; cursor:pointer;}
    .del:hover{background:#f3f4f6;}

    .muted{color:#6b7280; font-size:12px;}
    .toolbar{position:absolute; right:12px; bottom:12px; z-index:1000; background:#fff; padding:8px 10px; border-radius:12px; box-shadow:0 4px 16px rgba(0,0,0,.15); display:flex; align-items:center; gap:10px;}
    .toolbar label{display:flex; align-items:center; gap:6px; font-size:14px; color:#111827;}

    /* Durak & konum pinleri */
    .stop-pin{width:24px;height:24px;border-radius:50%;background:#2f80ed;color:#fff;display:flex;align-items:center;justify-content:center;border:2px solid #0e3ea3;}
    .stop-pin::after{content:"üöå";}
    .me-pin{position:relative; width:18px; height:18px; border-radius:50%; background:#10b981; border:2px solid #065f46; box-shadow:0 0 0 2px rgba(16,185,129,.25);}
    .me-pin::after{content:""; position:absolute; left:50%; top:50%; width:16px; height:16px; border-radius:50%; transform:translate(-50%,-50%); background:rgba(16,185,129,.35); animation:pulse 1.6s ease-out infinite;}
    @keyframes pulse{0%{transform:translate(-50%,-50%) scale(1); opacity:.9;}70%{transform:translate(-50%,-50%) scale(2.6); opacity:0;}100%{opacity:0;}}

    .popup-title{font-weight:700; margin-bottom:4px;}
    .popup-nav-btn{margin-top:6px; padding:7px 10px; border:0; border-radius:8px; background:#2f80ed; color:#fff; font-weight:700; cursor:pointer;}
    .lines-title{margin:6px 0 2px; font-weight:700;}
    .lines-list{margin:4px 0 0; padding-left:18px;}

    .toast{position:absolute; top:12px; right:12px; z-index:1100; background:#111827; color:#fff; padding:10px 12px; border-radius:10px; box-shadow:0 4px 16px rgba(0,0,0,.2); font-size:14px; display:none;}

    /* Hat arama kutusu (saƒü √ºst) */
    .route-search{position:absolute; top:12px; right:12px; z-index:1001; background:#fff; padding:10px; border-radius:12px; box-shadow:0 4px 16px rgba(0,0,0,.15); display:flex; gap:6px; align-items:center;}
    .route-search input{padding:8px 10px; border:1px solid #e5e7eb; border-radius:10px;}
    .route-search button{padding:8px 12px; border:0; border-radius:10px; background:#2f80ed; color:#fff; font-weight:700; cursor:pointer;}
  </style>
</head>
<body>
  <!-- Hat Arama -->
  <div class="route-search" role="region" aria-label="Hat Arama">
    <input id="routeInput" type="text" placeholder="Hat kodu (√∂rn. 40T, 500T)"/>
    <button id="routeSearchBtn">Ara</button>
  </div>

  <!-- Sol panel: Rota -->
  <div class="panel" role="region" aria-label="Rota paneli">
    <div class="panel-header">üß≠ Rota √áiz</div>
    <div class="panel-body">
      <div class="row">
        <label>Duraklar (s√ºr√ºkleyip sƒ±rala)</label>
        <div id="wpList" class="wp-list">
          <!-- Ba≈ülangƒ±√ß -->
          <div class="wp-item" data-key="start">
            <div class="drag" title="S√ºr√ºkle"></div>
            <div class="grid-2">
              <input id="startInput" type="text" placeholder="Ba≈ülangƒ±√ß (√∂rn. Taksim)"/>
              <button id="useLoc" class="btn btn-ghost" title="Konumumu kullan">üìç</button>
            </div>
            <button class="del" title="Sil" disabled>‚úï</button>
          </div>

          <!-- Ara duraklar buraya DOƒûRUDAN eklenecek -->

          <!-- Varƒ±≈ü -->
          <div class="wp-item" data-key="dest" id="destItem">
            <div class="drag" title="S√ºr√ºkle"></div>
            <input id="destInput" type="text" placeholder="Varƒ±≈ü (√∂rn. Kabata≈ü)"/>
            <button class="del" title="Sil" disabled>‚úï</button>
          </div>
        </div>

        <button id="addStop" class="btn btn-ghost" type="button" style="width:max-content">‚ûï Hedef ekle</button>
        <div class="muted">ƒ∞pucu: Rotadaki i≈üaret√ßileri harita √ºzerinde de s√ºr√ºkleyebilirsin.</div>
      </div>

      <div class="grid-2">
        <button id="drawBtn"  class="btn btn-primary">Rota √áiz</button>
        <button id="clearBtn" class="btn btn-muted">Temizle</button>
      </div>

      <div id="routeInfo" class="route-info" role="status" aria-live="polite"></div>
    </div>
  </div>

  <div class="toolbar">
    <button id="nearBtn" class="btn btn-ghost" title="Yakƒ±nla≈ü">Yakƒ±nƒ±m (Canlƒ±)</button>
    <label><input type="checkbox" id="toggleStops" checked/> Duraklar</label>
  </div>

  <div id="map"></div>
  <div id="toast" class="toast"></div>

  <!-- JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
  <!-- SortableJS (global) -->
  <script src="https://unpkg.com/sortablejs@1.15.2/Sortable.min.js"></script>

  <script>
    const API_BASE = "http://localhost:8000";
    const OSRM_URL = "https://router.project-osrm.org/route/v1";

    const map = L.map("map",{zoomControl:false}).setView([41.01,28.97],12);
    L.control.zoom({position:"bottomleft"}).addTo(map);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19, attribution:'&copy; OpenStreetMap'}).addTo(map);

    const clusters = (L.markerClusterGroup ? L.markerClusterGroup({ disableClusteringAtZoom: 16 }) : L.layerGroup()).addTo(map);
    const stopIcon = L.divIcon({ className:"stop-pin", iconSize:[24,24] });
    const meIcon   = L.divIcon({ className:"me-pin", iconSize:[18,18] });

    // Hat √ßizgileri i√ßin katman
    const hatLayer = L.layerGroup().addTo(map);

    const start = { key:"start", input: document.getElementById("startInput"), coord: null };
    const dest  = { key:"dest",  input: document.getElementById("destInput"),  coord: null };
    const via   = []; // { key, el, input, coord }
    const wpList = document.getElementById("wpList");
    const destItem = document.getElementById("destItem");

    const $ = s => document.querySelector(s);
    const toast = (m,ms=2200)=>{const t=$("#toast");t.textContent=m;t.style.display="block";clearTimeout(t._tid);t._tid=setTimeout(()=>t.style.display="none",ms);};

    /* ---------- Routing ---------- */
    const router = L.Routing.control({
      position:"topright",
      waypoints:[],
      collapsible:true,
      addWaypoints:true,
      draggableWaypoints:true,
      router: L.Routing.osrmv1({ serviceUrl: OSRM_URL, profile: "car" })
    })
    .on("routesfound", e => {
      const r = e.routes[0];
      $("#routeInfo").innerHTML = `üìè Mesafe: <b>${(r.summary.totalDistance/1000).toFixed(2)} km</b><br>‚è±Ô∏è S√ºre: <b>${Math.round(r.summary.totalTime/60)} dk</b>`;
      $("#routeInfo").style.display="block";
    })
    .on("waypointschanged", e => {
      const wps = e.waypoints||[];
      if (wps[0]?.latLng) start.coord = {lat:wps[0].latLng.lat, lon:wps[0].latLng.lng};
      const mids = wps.slice(1,-1);
      for (let i=0;i<via.length;i++) if (mids[i]?.latLng) via[i].coord = {lat:mids[i].latLng.lat, lon:mids[i].latLng.lng};
      if (wps[wps.length-1]?.latLng) dest.coord = {lat:wps[wps.length-1].latLng.lat, lon:wps[wps.length-1].latLng.lng};
    })
    .on("routingerror", ()=>toast("Rota bulunamadƒ±."))
    .addTo(map);

    const collect = () => {
      const pts=[];
      if (start.coord) pts.push(L.latLng(start.coord.lat, start.coord.lon));
      for(const r of via) if (r.coord) pts.push(L.latLng(r.coord.lat, r.coord.lon));
      if (dest.coord) pts.push(L.latLng(dest.coord.lat, dest.coord.lon));
      return pts;
    };
    const maybeRoute = () => { const pts=collect(); if(pts.length>=2) router.setWaypoints(pts); };

    async function geocode(q){
      const m=q.match(/^\s*(-?\d+(?:\.\d+)?)\s*,\s*(-?\d+(?:\.\d+)?)\s*$/);
      if(m) return {lat:+m[1], lon:+m[2]};
      const u=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1`;
      const r=await fetch(u); if(!r.ok) return null; const j=await r.json(); if(!j[0]) return null;
      return {lat:+j[0].lat, lon:+j[0].lon};
    }

    /* ---------- VIA UI ---------- */
    const newKey = ()=>"v"+Math.random().toString(36).slice(2,8);
    function addVia(value=""){
      const key=newKey();
      const el=document.createElement("div");
      el.className="wp-item"; el.dataset.key=key;
      el.innerHTML=`
        <div class="drag" title="S√ºr√ºkle"></div>
        <input type="text" class="via-input" placeholder="Ara durak (adres veya 41.0, 28.9)" value="${value}"/>
        <button class="del" title="Sil">‚úï</button>`;
      // DOƒûRUDAN #wpList i√ßine, varƒ±≈üƒ±n √∂n√ºne ekle:
      wpList.insertBefore(el, destItem);

      const row={key, el, input: el.querySelector(".via-input"), coord:null};
      via.push(row);
      el.querySelector(".del").onclick=()=>{ const i=via.findIndex(x=>x.key===key); if(i>=0){ via.splice(i,1); el.remove(); maybeRoute(); } };
      return row;
    }
    document.getElementById("addStop").onclick=()=>addVia("");

    /* ---------- DRAG & DROP (Sortable) ---------- */
    new Sortable(wpList, {
      handle: ".drag",
      animation: 150,
      draggable: ".wp-item",
      onEnd(){
        // √áocuklarƒ±n sƒ±rasƒ±nƒ± oku ‚Üí via dizisini yeniden sƒ±rala
        const order=[...wpList.children].map(el=>el.dataset.key);
        const newVia=[];
        for(const key of order){
          if(key==="start" || key==="dest") continue;
          const found = via.find(v=>v.key===key);
          if(found) newVia.push(found);
        }
        via.splice(0, via.length, ...newVia);
        maybeRoute();
      }
    });

    /* ---------- Duraklar (harita) ---------- */
    async function loadStops(){
      clusters.clearLayers();
      if (!document.getElementById("toggleStops").checked) return;
      const b=map.getBounds();
      const url=new URL(API_BASE+"/stops/geojson");
      url.searchParams.set("minLon",b.getWest());
      url.searchParams.set("maxLon",b.getEast());
      url.searchParams.set("minLat",b.getSouth());
      url.searchParams.set("maxLat",b.getNorth());
      url.searchParams.set("limit",2000);
      try{
        const r=await fetch(url); if(!r.ok) return toast("Duraklar y√ºklenemedi.");
        const g=await r.json();
        (g.features||[]).forEach(f=>{
          if(f.geometry?.type!=="Point") return;
          const [lon,lat]=f.geometry.coordinates;
          const name=f.properties?.name||"-";
          const sid = f.properties?.id || f.properties?.stop_id;

          const m=L.marker([lat,lon],{icon:stopIcon});
          m.bindPopup(`
            <div>
              <div class="popup-title">${name}</div>
              <div class="lines-title">üöç Hatlar</div>
              <div class="stop-lines" data-stop="${sid}">Y√ºkleniyor...</div>
              <button class="popup-nav-btn" data-lat="${lat}" data-lon="${lon}" data-name="${name}" data-stop="${sid}" type="button">üß≠ Yol tarifi al</button>
            </div>`);
          clusters.addLayer(m);
        });
      }catch{ toast("Durak isteƒüi ba≈üarƒ±sƒ±z."); }
    }
    map.on("moveend", loadStops); loadStops();

    map.on("popupopen", async (e)=>{
      const root=e.popup.getElement(); if(!root) return;

      // Hat listesi
      const div=root.querySelector(".stop-lines");
      if(div){
        const stopId=div.getAttribute("data-stop");
        try{
          const resp=await fetch(`${API_BASE}/stops/${encodeURIComponent(stopId)}/lines`);
          const data=await resp.json();
          const arr=data?.lines||[];
          div.innerHTML = arr.length
            ? `<ul class="lines-list">${arr.map(l=>`<li><b>${l.code??"-"}</b>${l.name?" ‚Äì "+l.name:""}</li>`).join("")}</ul>`
            : "Bu duraktan ge√ßen hat yok.";
        }catch{ div.textContent="Hatlar y√ºklenemedi."; }
      }

      // Yol tarifi + hat √∂nerisi (konuma en yakƒ±n durak ‚Üí tƒ±klanan durak)
      const navBtn=root.querySelector(".popup-nav-btn");
      if(navBtn){
        navBtn.onclick=()=>{
          const destLat=+navBtn.dataset.lat, destLon=+navBtn.dataset.lon;
          const stopId=navBtn.dataset.stop;
          dest.input.value = navBtn.dataset.name || "Durak";
          dest.coord = { lat:destLat, lon:destLon };

          if("geolocation" in navigator){
            navigator.geolocation.getCurrentPosition(async pos=>{
              start.input.value="Konumum";
              const sLat=pos.coords.latitude, sLon=pos.coords.longitude;
              start.coord={lat:sLat,lon:sLon};
              maybeRoute(); map.closePopup();

              // En yakƒ±n ba≈ülangƒ±√ß duraƒüƒ±nƒ± bul + iki durak arasƒ±nda hatlarƒ± sor
              const fromStopId = await findNearestStopId(sLat, sLon);
              if(fromStopId){
                await suggestTransit(fromStopId, stopId);
              } else {
                toast("Yakƒ±n durak bulunamadƒ±.");
              }
            }, async ()=>{
              const s=start.input.value.trim();
              if(s){ start.coord=await geocode(s); maybeRoute(); map.closePopup(); }
              else toast("Ba≈ülangƒ±√ß girin veya konumu a√ßƒ±n.");
            }, {enableHighAccuracy:true, maximumAge:5000, timeout:10000});
          } else toast("Ba≈ülangƒ±√ß i√ßin adres girin.");
        };
      }
    });

    /* ---------- Konum & Rota butonlarƒ± ---------- */
    document.getElementById("nearBtn").onclick = ()=>{
      if(!("geolocation" in navigator)) return toast("Tarayƒ±cƒ± konumu desteklemiyor.");
      navigator.geolocation.getCurrentPosition(pos=>{
        const lat=pos.coords.latitude,lon=pos.coords.longitude;
        if(!window.meMarker) window.meMarker=L.marker([lat,lon],{icon:meIcon}).addTo(map).bindTooltip("Canlƒ± konum");
        else window.meMarker.setLatLng([lat,lon]);
        map.setView([lat,lon],15);
      },()=>toast("Konum alƒ±namadƒ±."),{enableHighAccuracy:true,maximumAge:5000,timeout:10000});
    };
    document.getElementById("toggleStops").onchange = loadStops;

    document.getElementById("useLoc").onclick=()=>navigator.geolocation.getCurrentPosition(pos=>{
      start.input.value="Konumum";
      start.coord={lat:pos.coords.latitude,lon:pos.coords.longitude};
      if(!window.meMarker) window.meMarker=L.marker([start.coord.lat,start.coord.lon],{icon:meIcon}).addTo(map).bindTooltip("Canlƒ± konum");
      else window.meMarker.setLatLng([start.coord.lat,start.coord.lon]);
    },()=>toast("Konum izni gerekli."));

    document.getElementById("drawBtn").onclick=async()=>{
      if(!start.coord){ const s=start.input.value.trim(); if(s) start.coord=await geocode(s); }
      for(const r of via){ if(!r.coord){ const v=r.input.value.trim(); if(v) r.coord=await geocode(v); } }
      if(!dest.coord){ const d=dest.input.value.trim(); if(d) dest.coord=await geocode(d); }
      if(!start.coord || !dest.coord) return toast("Ba≈ülangƒ±√ß ve varƒ±≈ü gerekli.");
      router.setWaypoints(collect());
    };

    document.getElementById("clearBtn").onclick=()=>{
      start.coord=dest.coord=null; via.forEach(r=>r.coord=null);
      start.input.value=""; dest.input.value="";
      [...wpList.querySelectorAll('.wp-item')].forEach(el=>{
        if(el.dataset.key && !['start','dest'].includes(el.dataset.key)) el.remove();
      });
      via.splice(0);
      router.setWaypoints([]); $("#routeInfo").style.display="none";
      hatLayer.clearLayers(); // hat √ßizgilerini de temizle
    };

    /* ---------- Hat Arama ---------- */
    document.getElementById("routeSearchBtn").onclick = async ()=>{
      const q=document.getElementById("routeInput").value.trim();
      if(!q){ toast("Hat kodu gir."); return; }
      hatLayer.clearLayers();
      try{
        const r=await fetch(`${API_BASE}/routes/search?q=${encodeURIComponent(q)}`);
        const j=await r.json();
        const list = j.results || (j.ok && j.hat ? [j.hat] : []);
        if(!j.ok || !list.length){ toast("Hat bulunamadƒ±."); return; }
        const best=list[0];
        // best.guzergah -> [{lat,lon}] veya [[lon,lat]...]
        const coords = (best.guzergah||[]).map(c =>
          Array.isArray(c) ? [c[1],c[0]] : [c.lat, c.lon]
        );
        if(!coords.length){ toast("Bu hat i√ßin g√ºzergah verisi yok."); return; }
        const line=L.polyline(coords,{color:"red", weight:5, opacity:.85}).addTo(hatLayer);
        map.fitBounds(line.getBounds());
        toast(`√áizildi: ${best.hat_kodu||q}`);
      }catch(e){ toast("Hat arama hata verdi."); }
    };

    /* ---------- En yakƒ±n durak bul + hat √∂nerisi ---------- */
    async function findNearestStopId(lat,lon){
      const delta=0.02; // ~2km civarƒ±
      const url=new URL(API_BASE+"/stops/geojson");
      url.searchParams.set("minLon", (lon-delta));
      url.searchParams.set("maxLon", (lon+delta));
      url.searchParams.set("minLat", (lat-delta));
      url.searchParams.set("maxLat", (lat+delta));
      url.searchParams.set("limit", 1000);
      try{
        const r=await fetch(url); if(!r.ok) return null;
        const g=await r.json(); const feats=g.features||[];
        if(!feats.length) return null;
        let best=null, bestD=1e18;
        for(const f of feats){
          const [LON,LAT]=f.geometry.coordinates;
          const d=haversine(lat,lon,LAT,LON);
          if(d<bestD){ bestD=d; best=f; }
        }
        return best?.properties?.id || best?.properties?.stop_id || null;
      }catch{ return null; }
    }

    function haversine(lat1,lon1,lat2,lon2){
      const toRad=d=>d*Math.PI/180;
      const R=6371000;
      const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
      const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return 2*R*Math.asin(Math.sqrt(a));
    }

    async function suggestTransit(fromStopId, toStopId){
      try{
        const r=await fetch(`${API_BASE}/routes/between?from=${encodeURIComponent(fromStopId)}&to=${encodeURIComponent(toStopId)}`);
        const j=await r.json();
        if(!j.results || !j.results.length){ toast("Bu iki durak arasƒ±nda hat bulunamadƒ±."); return; }
        const best=j.results[0];
        hatLayer.clearLayers();
        const coords=(best.guzergah||[]).map(c=>Array.isArray(c)?[c[1],c[0]]:[c.lat,c.lon]);
        const line=L.polyline(coords,{color:"blue", weight:5, opacity:0.8}).addTo(hatLayer);
        map.fitBounds(line.getBounds());
        toast(`Toplu ta≈üƒ±ma √∂nerisi: ${best.hat_kodu}`);
      }catch{ toast("Hat √∂nerisi alƒ±namadƒ±."); }
    }
  </script>
</body>
</html>
