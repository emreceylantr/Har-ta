<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>HaydiGo ‚Äî Duraklar & Rota</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css"/>

  <style>
    html, body, #map { height:100%; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }

    /* Panel (dokunma) */
    .panel{position:absolute; top:12px; left:12px; z-index:1000; background:#fff; border-radius:14px; width:320px; box-shadow:0 6px 18px rgba(0,0,0,.18); overflow:hidden;}
    .panel-header{background:#2f80ed; color:#fff; padding:12px 14px; font-weight:700;}
    .panel-body{padding:12px; display:flex; flex-direction:column; gap:10px;}
    .row{display:flex; flex-direction:column; gap:6px;}
    label{font-size:12px; color:#374151; font-weight:600;}
    input[type="text"]{width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; outline:none;}
    input[type="text"]:focus{border-color:#2f80ed; box-shadow:0 0 0 3px rgba(47,128,237,.1);}
    .btn{padding:10px 12px; border:0; border-radius:10px; cursor:pointer; font-weight:700;}
    .btn-primary{background:#2f80ed; color:#fff;} .btn-primary:hover{background:#2564b8;}
    .btn-ghost{background:#eef2ff; color:#1f2937;} .btn-ghost:hover{background:#e0e7ff;}
    .btn-muted{background:#f3f4f6; color:#374151;} .btn-muted:hover{background:#e5e7eb;}
    .grid-2{display:grid; grid-template-columns:1fr 1fr; gap:8px;}
    .route-info{display:none; margin-top:2px; font-size:14px; background:#f9fafb; padding:8px; border-radius:8px; border:1px solid #e5e7eb;}

    /* Saƒü alttaki toolbar */
    .toolbar{position:absolute; right:12px; bottom:12px; z-index:1000; background:#fff; padding:8px 10px; border-radius:12px; box-shadow:0 4px 16px rgba(0,0,0,.15); display:flex; align-items:center; gap:10px;}
    .toolbar label{display:flex; align-items:center; gap:6px; font-size:14px; color:#111827;}

    /* Durak ve canlƒ± konum ikonlarƒ± */
    .stop-pin{width:24px;height:24px;border-radius:50%;background:#2f80ed;color:#fff;display:flex;align-items:center;justify-content:center;border:2px solid #0e3ea3;}
    .stop-pin::after{content:"üöå";}

    /* Yanƒ±p s√∂nen ye≈üil canlƒ± konum */
    .me-pin{position:relative; width:18px; height:18px; border-radius:50%; background:#10b981; border:2px solid #065f46; box-shadow:0 0 0 2px rgba(16,185,129,.25);}
    .me-pin::after{
      content:""; position:absolute; left:50%; top:50%;
      width:16px; height:16px; border-radius:50%;
      transform:translate(-50%,-50%); background:rgba(16,185,129,.35);
      animation:pulse 1.6s ease-out infinite;
    }
    @keyframes pulse{
      0%{transform:translate(-50%,-50%) scale(1); opacity:.9;}
      70%{transform:translate(-50%,-50%) scale(2.6); opacity:0;}
      100%{opacity:0;}
    }

    /* Popup i√ßi */
    .popup-title{font-weight:700; margin-bottom:4px;}
    .popup-nav-btn{margin-top:6px; padding:7px 10px; border:0; border-radius:8px; background:#2f80ed; color:#fff; font-weight:700; cursor:pointer;}
    .popup-nav-btn:hover{background:#2564b8;}
    .lines-title{margin:6px 0 2px; font-weight:700;}
    .lines-list{margin:4px 0 0; padding-left:18px;}

    /* K√º√ß√ºk bildirim */
    .toast{position:absolute; top:12px; right:12px; z-index:1100; background:#111827; color:#fff; padding:10px 12px; border-radius:10px; box-shadow:0 4px 16px rgba(0,0,0,.2); font-size:14px; display:none;}
  </style>
</head>
<body>
  <div class="panel" role="region" aria-label="Rota paneli">
    <div class="panel-header">üß≠ Rota √áiz</div>
    <div class="panel-body">
      <div class="row">
        <label for="startInput">Ba≈ülangƒ±√ß</label>
        <div class="grid-2">
          <input id="startInput" type="text" placeholder="Taksim Meydanƒ±"/>
          <button id="useLoc" class="btn btn-ghost" title="Konumumu kullan">üìç</button>
        </div>
      </div>
      <div class="row">
        <label for="destInput">Varƒ±≈ü</label>
        <input id="destInput" type="text" placeholder="Galata Kulesi"/>
      </div>
      <div class="grid-2">
        <button id="drawBtn"  class="btn btn-primary">Rota √áiz</button>
        <button id="clearBtn" class="btn btn-muted">Temizle</button>
      </div>
      <div id="routeInfo" class="route-info" role="status" aria-live="polite"></div>
    </div>
  </div>

  <div class="toolbar">
    <button id="nearBtn" class="btn btn-ghost" title="Yakƒ±nla≈ü">Yakƒ±nƒ±m (Canlƒ±)</button>
    <label><input type="checkbox" id="toggleStops" checked/> Duraklar</label>
  </div>

  <div id="map" aria-label="Harita"></div>
  <div id="toast" class="toast"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

  <script>
    const API_BASE = "http://localhost:8000";
    const OSRM_URL = "https://router.project-osrm.org/route/v1"; // demo (profil: car)

    const map = L.map("map",{zoomControl:false}).setView([41.01,28.97],12);
    L.control.zoom({position:"bottomleft"}).addTo(map);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19, attribution:'&copy; OpenStreetMap'}).addTo(map);

    const clusters = L.markerClusterGroup({ disableClusteringAtZoom: 16 }).addTo(map);
    const stopIcon = L.divIcon({ className:"stop-pin", iconSize:[24,24] });
    const meIcon   = L.divIcon({ className:"me-pin", iconSize:[18,18] }); // pulsing live marker

    let startCoord=null, destCoord=null, meMarker=null, showStops=true;
    let stopsAbort=null, geoWatchId=null;

    const $  = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);
    const h = s => String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const toast = (msg, ms=2200) => { const t=$("#toast"); t.textContent=msg; t.style.display="block"; clearTimeout(t._tid); t._tid=setTimeout(()=>t.style.display="none", ms); };

    // Rota ‚Äî OSRM demo, car profili
    const router = L.Routing.control({
      position:"topright",
      waypoints:[],
      collapsible:true,
      addWaypoints:false,
      router: L.Routing.osrmv1({ serviceUrl: OSRM_URL, profile: "car" })
    })
    .on("routesfound", e => {
      const r = e.routes[0];
      const km = (r.summary.totalDistance/1000).toFixed(2);
      const min = Math.round(r.summary.totalTime/60);
      const info = $("#routeInfo");
      info.innerHTML = `üìè Mesafe: <b>${km} km</b><br>‚è±Ô∏è S√ºre: <b>${min} dk</b>`;
      info.style.display = "block";
    })
    .on("routingerror", () => toast("Rota bulunamadƒ±."))
    .addTo(map);

    const maybeRoute = () => {
      if (startCoord && destCoord) {
        router.setWaypoints([
          L.latLng(startCoord.lat, startCoord.lon),
          L.latLng(destCoord.lat, destCoord.lon)
        ]);
      }
    };

    async function geocode(q){
      const u=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1`;
      const r=await fetch(u); if(!r.ok) return null;
      const j=await r.json(); if(!j[0]) return null;
      return {lat:+j[0].lat,lon:+j[0].lon};
    }

    // Duraklar
    const loadStops = async () => {
      clusters.clearLayers();
      if (!showStops) return;
      if (stopsAbort) stopsAbort.abort();
      stopsAbort = new AbortController();

      const b = map.getBounds();
      const url = new URL(API_BASE + "/stops/geojson");
      url.searchParams.set("minLon", b.getWest());
      url.searchParams.set("maxLon", b.getEast());
      url.searchParams.set("minLat", b.getSouth());
      url.searchParams.set("maxLat", b.getNorth());
      url.searchParams.set("limit", 2000);

      try{
        const r = await fetch(url, { signal: stopsAbort.signal });
        if(!r.ok){ toast("Duraklar y√ºklenemedi."); return; }
        const g = await r.json();
        (g.features||[]).forEach(f=>{
          if(f.geometry?.type!=="Point") return;
          const [lon,lat]=f.geometry.coordinates;
          const name = h(f.properties?.name || "-");
          const sid  = f.properties?.id || f.properties?.stop_id;

          const m=L.marker([lat,lon],{icon:stopIcon});
          m.bindPopup(`
            <div>
              <div class="popup-title">${name}</div>
              <div class="lines-title">üöç Hatlar</div>
              <div class="stop-lines" data-stop="${h(sid)}">Y√ºkleniyor...</div>
              <button class="popup-nav-btn" data-lat="${lat}" data-lon="${lon}" data-name="${name}" type="button">üß≠ Yol tarifi al</button>
            </div>
          `);
          clusters.addLayer(m);
        });
      }catch(e){
        if(e.name!=="AbortError") toast("Durak isteƒüi iptal edildi/ba≈üarƒ±sƒ±z.");
      }
    };
    let moveTid=null;
    map.on("moveend",()=>{ clearTimeout(moveTid); moveTid=setTimeout(loadStops,200); });
    loadStops();

    // Popup a√ßƒ±lƒ±nca: hatlarƒ± getir + Yol tarifi al butonuna tƒ±k davranƒ±≈üƒ±
    map.on("popupopen", async (e)=>{
      const root=e.popup.getElement(); if(!root) return;

      // Yol tarifi al
      const navBtn=root.querySelector(".popup-nav-btn");
      if(navBtn){
        navBtn.onclick=()=>{
          // Varƒ±≈ü = durak
          destCoord={lat:+navBtn.dataset.lat, lon:+navBtn.dataset.lon};
          $("#destInput").value=navBtn.dataset.name||"Durak";

          // Ba≈ülangƒ±√ß = canlƒ± konum
          if(!("geolocation" in navigator)){ toast("Tarayƒ±cƒ± konumu desteklemiyor."); return; }
          navigator.geolocation.getCurrentPosition(pos=>{
            startCoord={lat:pos.coords.latitude, lon:pos.coords.longitude};
            $("#startInput").value="Konumum";
            // Rota √ßiz
            maybeRoute();
            // Popup'ƒ± kapat
            map.closePopup();
          }, ()=>toast("Konum izni gerekli."), { enableHighAccuracy:true, maximumAge:5000, timeout:10000 });
        };
      }

      // Hatlar
      const div=root.querySelector(".stop-lines");
      if(!div) return;
      const stopId=div.getAttribute("data-stop");
      if(!stopId){div.textContent="Durak ID yok."; return;}
      try{
        const resp=await fetch(`${API_BASE}/stops/${encodeURIComponent(stopId)}/lines`);
        if(!resp.ok) throw 0;
        const data=await resp.json();
        const arr=data?.lines||[];
        div.innerHTML = arr.length
          ? `<ul class="lines-list">${arr.map(l=>`<li><b>${h(l.code??"-")}</b>${l.name?" ‚Äì "+h(l.name):""}</li>`).join("")}</ul>`
          : "Bu duraktan ge√ßen hat yok.";
      }catch{
        div.textContent="Hatlar y√ºklenemedi.";
      }
    });

    // Canlƒ± konum (yanƒ±p s√∂nen)
    const startLiveLocate = ()=>{
      if(!("geolocation" in navigator)){ toast("Tarayƒ±cƒ± konumu desteklemiyor."); return; }
      if(geoWatchId) return;
      geoWatchId = navigator.geolocation.watchPosition(pos=>{
        const lat=pos.coords.latitude, lon=pos.coords.longitude;
        if(!meMarker){
          meMarker = L.marker([lat,lon], { icon: meIcon }).addTo(map).bindTooltip("Canlƒ± konum");
          map.setView([lat,lon], 15);
        }else{
          meMarker.setLatLng([lat,lon]);
        }
      }, ()=>toast("Konum alƒ±namadƒ±."), { enableHighAccuracy:true, maximumAge:5000, timeout:10000 });
    };

    // UI
    $("#toggleStops").onchange=e=>{ showStops=e.target.checked; loadStops(); };
    $("#nearBtn").onclick = startLiveLocate;

    $("#useLoc").onclick=()=>navigator.geolocation.getCurrentPosition(pos=>{
      startCoord={lat:pos.coords.latitude,lon:pos.coords.longitude};
      $("#startInput").value="Konumum";
      if(!meMarker){
        meMarker = L.marker([startCoord.lat,startCoord.lon], { icon: meIcon }).addTo(map).bindTooltip("Canlƒ± konum");
      }else{
        meMarker.setLatLng([startCoord.lat,startCoord.lon]);
      }
    },()=>toast("Konum izni gerekli."));

    $("#drawBtn").onclick=async()=>{
      if(!startCoord){
        const s=$("#startInput").value.trim();
        if(s) startCoord=await geocode(s);
      }
      if(!destCoord){
        const d=$("#destInput").value.trim();
        if(d) destCoord=await geocode(d);
      }
      if(!startCoord || !destCoord){ toast("Ba≈ülangƒ±√ß ve varƒ±≈ü gerekli."); return; }
      maybeRoute();
    };

    $("#clearBtn").onclick=()=>{
      startCoord=destCoord=null;
      $("#startInput").value=""; $("#destInput").value="";
      router.setWaypoints([]); $("#routeInfo").style.display="none";
    };
  </script>
</body>
</html>
